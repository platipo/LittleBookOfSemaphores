% LaTeX source for textbook ``The Little Book of Semaphores, 2nd edition''
% Copyright 2016 Allen B. Downey.

% Permission is granted to copy, distribute and/or modify this
% document under the terms of the Creative Commons
% Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)
% http://creativecommons.org/licenses/by-nc-sa/4.0/

\documentclass{book}
\usepackage[a4paper,
 total={170mm,257mm},
 left=20mm,
 top=20mm,
]{geometry}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage{graphicx}
\graphicspath{ {./figs/} }
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{url}
\usepackage{makeidx}

\usepackage{parskip}
\usepackage{tcolorbox}
\tcbuselibrary{most,listings}

\usepackage[colorlinks=true, linkcolor=blue, urlcolor=blue]{hyperref}


\title{The Little Book of Semaphores}
\author{Allen B. Downey}
\newcommand{\theversion}{Version 2.2.1}

\sloppy

\newcommand{\clearemptydoublepage}{\newpage\cleardoublepage}
\newcommand{\blankpage}{\newpage}

\pagestyle{fancyplain}

\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}{}}

\lhead[\fancyplain{}{\bfseries\thepage}]%
      {\fancyplain{}{\bfseries\rightmark}}
\rhead[\fancyplain{}{\bfseries\leftmark}]%
      {\fancyplain{}{\bfseries\thepage}}
\cfoot{}

% conditional compiling for compactness
\newif\ifnotcompact
\notcompacttrue
%\notcompactfalse

\ifnotcompact
\colorlet{PUZZCOLFRAM}{blue!30!black!85}
\colorlet{PUZZCOLBACK}{gray!8!blue!10}
\colorlet{LSTCOLTITL}{blue!20!black!65}
\colorlet{LSTCOLFRAM}{gray!45!blue!35}
\colorlet{LSTCOLBACK}{gray!7!blue!7}
\else
\colorlet{PUZZCOLFRAM}{gray!70!black!85}
\colorlet{PUZZCOLBACK}{gray!8}
\colorlet{LSTCOLTITL}{gray!70!black!65}
\colorlet{LSTCOLFRAM}{gray!45}
\colorlet{LSTCOLBACK}{gray!5}
\fi

\newtcolorbox{puzzlebox}[1]{reset,
    colback=PUZZCOLBACK, colframe=PUZZCOLFRAM,
    breakable, fonttitle=\large\bfseries,title=#1,
    subtitle style={boxrule=0.4pt,before skip=\baselineskip}
}
\newtcblisting{lsthalfbox}[2][]{%
    before=, after=\hfill, width=(\linewidth-4mm)/2, title=#2, #1,
    colbacktitle=LSTCOLTITL, colframe=LSTCOLFRAM, colback=LSTCOLBACK,
    enhanced, attach boxed title to top center={yshift=-2.5mm},
    boxed title style={size=small},
    fonttitle=\bfseries, listing options={style=tcblatex,
    numbers=left,numberstyle=\tiny\bfseries,numbersep=0.8em,
    escapeinside={(*}{*)}}, listing only, valign=center, left=5mm
}
\newtcblisting{lstbox}[1]{%
    breakable, title=#1,
    colbacktitle=LSTCOLTITL, colframe=LSTCOLFRAM, colback=LSTCOLBACK,
    enhanced, attach boxed title to top center={yshift=-2.5mm},
    boxed title style={size=small},
    fonttitle=\bfseries, listing options={style=tcblatex,
    numbers=left,numberstyle=\tiny\bfseries,numbersep=0.8em,
    escapeinside={(*}{*)}}, listing only, valign=center, left=5mm
}
\newtcbinputlisting{\lstinputbox}[2]{%
    breakable, title=#1, listing file={#2},
    colbacktitle=LSTCOLTITL, colframe=LSTCOLFRAM, colback=LSTCOLBACK,
    enhanced, attach boxed title to top center={yshift=-2.5mm},
    boxed title style={size=small},
    fonttitle=\bfseries, listing options={style=tcblatex,
    numbers=left,numberstyle=\tiny\bfseries,numbersep=0.8em,
    escapeinside={(*}{*)}}, listing only, valign=center, left=5mm
}

\newcommand{\subsec}[1]{%
    \subsection*{#1}
    \addcontentsline{toc}{subsection}{#1}
    \addtocounter{subsection}{1}
}
\newcommand{\sub}[1]{%
    \vspace{0.3em}
    \textbf{\large{#1}}
    \vspace{-0.4em}
}

\makeindex

\begin{document}
\maketitle

\ifnotcompact
\frontmatter

\chapter{Preface}

\input{chap/chap00}

\else
\null
\fi

\vfill

\begin{center}
The Little Book of Semaphores, second edition, \theversion
\vspace{0.25in}

Copyright 2016 Allen B. Downey
\end{center}
\vspace{0.25in}

\input{chap/copr}

\ifnotcompact
\else
\frontmatter
\fi

\tableofcontents
\clearemptydoublepage

\mainmatter


\chapter{Introduction}

\input{chap/chap01}

%% \clearemptydoublepage
\chapter{Semaphores}

\input{chap/chap02}

%% \clearemptydoublepage
\chapter{Basic synchronization patterns}

\input{chap/chap03}

\clearemptydoublepage
\chapter{Classical synchronization problems}

\input{chap/chap04}

\clearemptydoublepage
\chapter{Less classical synchronization problems}
\label{next}

\input{chap/chap05}

\clearemptydoublepage
\chapter{Not-so-classical problems}

\input{chap/chap06}

\clearemptydoublepage
\chapter{Not remotely classical problems}

\input{chap/chap07}

\ifnotcompact
\chapter{Synchronization in Python}
\label{pysync}

\input{chap/chap08}

\chapter{Synchronization in C}
\label{csync}

\input{chap/chap09}

\fi

\phantomsection
\addcontentsline{toc}{chapter}{Bibliography}

\bibliographystyle{plain}
\bibliography{book}

\ifnotcompact
\appendix

\chapter{Cleaning up Python threads}
\label{cleanup}

\input{chap/appx01}

\chapter{Cleaning up POSIX threads}
\label{ccleanup}

\input{chap/appx02}

\fi

\end{document}

